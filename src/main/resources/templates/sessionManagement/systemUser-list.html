<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head th:replace="~{fragments/template :: head}"></head>
<body>
    <nav th:replace="~{fragments/template :: menu}"></nav>
    <h1>System Users</h1>
    <div id="search-panel">
        <div th:replace="~{sessionManagement/sessionFragments/systemUserList-search :: systemUser-search}"></div>
    </div>
    <hr style="height: 2px; background-color: #333; width: 70%; margin: 20px auto 20px 0;">
    <div id="datatable-panel">
        <div th:replace="~{sessionManagement/sessionFragments/systemUserList-datatable :: systemUser-datatable}"></div>
        <p th:if="${message}" th:text="${message}"></p>
    </div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const searchForm = document.getElementById("searchForm");
        const pageSizeSelect = document.getElementById("pageSize");
        let currentPage = 0; // Use currentPage instead of page

        function updateTable(queryString) {
            fetch(`/systemUser-list?${queryString}`, {
                method: "GET",
                headers: {
                    "X-Requested-With": "searchRequest"
                }
            })
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const htmlDocument = parser.parseFromString(data, "text/html");
                    replaceElementContent("#systemUserDatatable tbody", htmlDocument.querySelector("#systemUserDatatable tbody"));
                    replaceElementContent("#pagination", htmlDocument.querySelector("#pagination"));
                    updatePagination(htmlDocument); // Update pagination state (optional)
                })
                .catch(error => console.error('Error:', error));
        }

        function addEventListenersToSelects() {
            document.querySelectorAll("#systemUserDatatable select").forEach(select => {
                select.addEventListener("change", function() {
                    // Atualiza os valores no formulário sem enviar AJAX
                    const formData = new FormData(searchForm);
                    const queryString = new URLSearchParams(formData).toString();
                    const pageSize = pageSizeSelect.value;

                    // Aqui atualizamos o queryString com o valor atual do formulário
                    updateFormValues(queryString, pageSize);
                });
            });
        }

        function replaceElementContent(selector, newContent) {
            const element = document.querySelector(selector);
            if (element) {
                element.parentNode.replaceChild(newContent, element);
            }
        }

        function updatePagination(htmlDocument) {
            const currentPageElement = htmlDocument.getElementById("currentPage");
            if (currentPageElement) {
                currentPage = parseInt(currentPageElement.textContent) - 1; // Adjust for 0-based indexing
            }
        }

        function updateFormValues(formData, queryString) {
            const urlParams = new URLSearchParams(queryString);
            for (const [key, value] of urlParams.entries()) {
                formData.append(key, value);
            }
        }

        function submitSearch(event) {
            event.preventDefault();

            const formData = new FormData(searchForm);
            const queryString = new URLSearchParams(formData).toString();
            const pageSize = pageSizeSelect.value;

            updateTable(`${queryString}&size=${pageSize}&page=${currentPage}`);
        }

        searchForm.addEventListener("submit", submitSearch);

        pageSizeSelect.addEventListener("change", function(event) {
            currentPage = 0; // Reset page on page size change
            submitSearch(event);
        });

        window.goToPreviousPage = function(event) {
            event.preventDefault();
            const prevPageLink = document.getElementById("prevPage");
            if (prevPageLink.hasAttribute("disabled")) return;

            currentPage--;
            submitSearch(event);
        };

        window.goToNextPage = function(event) {
            event.preventDefault();
            const nextPageLink = document.getElementById("nextPage");
            if (nextPageLink.hasAttribute("disabled")) return;

            currentPage++;
            submitSearch(event);
        };

        addEventListenersToSelects(); // Add listeners initially
    });

    /*document.addEventListener("DOMContentLoaded", function() {
        const searchForm = document.getElementById("searchForm");
        const pageSizeSelect = document.getElementById("pageSize");
        let page = 0;

        function updateTable(queryString) {
            fetch(`/systemUser-list?${queryString}`, {
                method: "GET",
                headers: {
                    "X-Requested-With": "searchRequest"
                }
            })
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const htmlDocument = parser.parseFromString(data, "text/html");
                    const newTableBody = htmlDocument.querySelector("#systemUserDatatable tbody");
                    const oldTableBody = document.querySelector("#systemUserDatatable tbody");
                    oldTableBody.parentNode.replaceChild(newTableBody, oldTableBody);

                    const newPagination = htmlDocument.querySelector("#pagination");
                    const oldPagination = document.querySelector("#pagination");
                    oldPagination.parentNode.replaceChild(newPagination, oldPagination);

                    addEventListenersToSelects(); // Re-adiciona listeners aos novos selects
                })
                .catch(error => console.error('Error:', error));
        }

        function addEventListenersToSelects() {
            document.querySelectorAll("#systemUserDatatable select").forEach(select => {
                select.addEventListener("change", function() {
                    // Atualiza os valores no formulário sem enviar AJAX
                    const formData = new FormData(searchForm);
                    const queryString = new URLSearchParams(formData).toString();
                    const pageSize = pageSizeSelect.value;

                    // Aqui atualizamos o queryString com o valor atual do formulário
                    updateFormValues(queryString, pageSize);
                });
            });
        }

        function updateFormValues(queryString, pageSize) {
            // Apenas atualiza os valores do formulário
            const formData = new FormData(searchForm);
            for (const [key, value] of new URLSearchParams(queryString)) {
                if (formData.has(key)) {
                    formData.set(key, value);
                } else {
                    formData.append(key, value);
                }
            }
        }

        searchForm.addEventListener("submit", function(event) {
            event.preventDefault();

            const formData = new FormData(searchForm);
            const queryString = new URLSearchParams(formData).toString();
            const pageSize = pageSizeSelect.value;

            updateTable(`${queryString}&size=${pageSize}&page=0`);
        });

        pageSizeSelect.addEventListener("change", function(event) {
            //event.preventDefault();
            const formData = new FormData(searchForm);
            const queryString = new URLSearchParams(formData).toString();
            const pageSize = pageSizeSelect.value;

            updateTable(`${queryString}&size=${pageSize}&page=${page}`); // page=0

        });

        window.goToPreviousPage = function(event) {
            event.preventDefault();
            const prevPageLink = document.getElementById("prevPage");
            if (prevPageLink.hasAttribute("disabled")) return;

            const formData = new FormData(searchForm);
            const queryString = new URLSearchParams(formData).toString();
            const pageSize = pageSizeSelect.value;
            const currentPage = parseInt(document.getElementById("currentPage").textContent) - 1;
            page = currentPage - 1;

            updateTable(`${queryString}&size=${pageSize}&page=${page}`);
        };

        window.goToNextPage = function(event) {
            event.preventDefault();
            const nextPageLink = document.getElementById("nextPage");
            if (nextPageLink.hasAttribute("disabled")) return;

            const formData = new FormData(searchForm);
            const queryString = new URLSearchParams(formData).toString();
            const pageSize = pageSizeSelect.value;
            const currentPage = parseInt(document.getElementById("currentPage").textContent) - 1;
            page = currentPage + 1;

            updateTable(`${queryString}&size=${pageSize}&page=${page}`);
        }

        addEventListenersToSelects(); // Inicialmente adiciona listeners aos selects
    });*/
</script>
</html>